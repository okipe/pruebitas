<div class="product-admin-list">
  
  <!-- Header -->
  <div class="page-header">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h1 class="page-title">
            <i class="fas fa-boxes me-3"></i>
            Gestión de Productos
          </h1>
          <p class="page-subtitle">{{ resumenFiltrado }}</p>
        </div>
        <div class="col-md-6 text-end">
          <button class="btn btn-secondary-custom me-2" routerLink="/admin">
            <i class="fas fa-arrow-left me-2"></i>
            Volver al Dashboard
          </button>
          <button class="btn btn-primary-custom" routerLink="/admin/products/new">
            <i class="fas fa-plus me-2"></i>
            Nuevo Producto
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid py-4">
    
    <!-- Filtros -->
    <div class="filters-section mb-4">
      <div class="row">
        <div class="col-md-8">
          <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input 
              type="text" 
              class="form-control" 
              placeholder="Buscar por nombre, categoría o descripción..."
              [(ngModel)]="terminoBusqueda"
              (ngModelChange)="onBusquedaChange()"
            >
          </div>
        </div>
        <div class="col-md-4">
          <select 
            class="form-select" 
            [(ngModel)]="filtroEstado"
            (change)="onFiltroEstadoChange()"
          >
            <option value="todos">Todos los productos</option>
            <option value="activos">Solo activos</option>
            <option value="inactivos">Solo inactivos</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Loader -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-3">Cargando productos...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error" class="alert alert-danger" role="alert">
      <i class="fas fa-exclamation-circle me-2"></i>
      {{ error }}
      <button class="btn btn-sm btn-outline-danger ms-3" (click)="cargarProductos()">
        Reintentar
      </button>
    </div>

    <!-- Tabla de Productos -->
    <div *ngIf="!loading && !error" class="products-table-container">
      
      <!-- Sin productos -->
      <div *ngIf="productosFiltrados.length === 0" class="no-products">
        <i class="fas fa-inbox fa-3x mb-3"></i>
        <p>No se encontraron productos</p>
        <button class="btn btn-primary-custom" routerLink="/admin/products/new">
          <i class="fas fa-plus me-2"></i>
          Crear primer producto
        </button>
      </div>

      <!-- Tabla -->
      <div *ngIf="productosFiltrados.length > 0" class="table-responsive">
        <table class="table products-table">
          <thead>
            <tr>
              <th style="width: 80px;">Imagen</th>
              <th>Producto</th>
              <th>Categoría</th>
              <th style="width: 100px;">Precio</th>
              <th style="width: 80px;">Stock</th>
              <th style="width: 100px;">Estado</th>
              <th style="width: 200px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let producto of productosFiltrados" [class.inactive-row]="!producto.estado">
              
              <!-- Imagen -->
              <td>
                <div class="product-image-cell">
                  <img 
                    [src]="producto.imagen || 'assets/images/placeholder-product.jpg'" 
                    [alt]="producto.nombre"
                    (error)="$any($event.target).src='assets/images/placeholder-product.jpg'"
                  >
                </div>
              </td>

              <!-- Producto -->
              <td>
                <div class="product-name-cell">
                  <strong>{{ producto.nombre }}</strong>
                  <small class="text-muted d-block">{{ producto.descripcion | slice:0:60 }}...</small>
                </div>
              </td>

              <!-- Categoría -->
              <td>
                <span class="badge bg-secondary">{{ producto.categoria }}</span>
              </td>

              <!-- Precio -->
              <td>
                <strong>S/. {{ producto.precio | number:'1.2-2' }}</strong>
              </td>

              <!-- Stock -->
              <td>
                <span 
                  class="badge" 
                  [class.bg-success]="producto.stock >= 10"
                  [class.bg-warning]="producto.stock > 0 && producto.stock < 10"
                  [class.bg-danger]="producto.stock === 0"
                >
                  {{ producto.stock }}
                </span>
              </td>

              <!-- Estado -->
              <td>
                <span 
                  class="badge" 
                  [class.bg-success]="producto.estado"
                  [class.bg-secondary]="!producto.estado"
                >
                  {{ producto.estado ? 'Activo' : 'Inactivo' }}
                </span>
              </td>

              <!-- Acciones -->
              <td>
                <div class="action-buttons">
                  
                  <!-- Editar -->
                  <button 
                    class="btn btn-sm btn-primary" 
                    [routerLink]="['/admin/products/edit', producto.uuidProducto]"
                    title="Editar"
                  >
                    <i class="fas fa-edit"></i>
                  </button>

                  <!-- Actualizar Stock -->
                  <button 
                    class="btn btn-sm btn-info" 
                    (click)="actualizarStock(producto)"
                    title="Actualizar stock"
                  >
                    <i class="fas fa-boxes"></i>
                  </button>

                  <!-- Activar/Desactivar -->
                  <button 
                    class="btn btn-sm" 
                    [class.btn-warning]="producto.estado"
                    [class.btn-success]="!producto.estado"
                    (click)="cambiarEstado(producto)"
                    [title]="producto.estado ? 'Desactivar' : 'Activar'"
                  >
                    <i class="fas" [class.fa-eye-slash]="producto.estado" [class.fa-eye]="!producto.estado"></i>
                  </button>

                  <!-- Eliminar -->
                  <button 
                    class="btn btn-sm btn-danger" 
                    (click)="confirmarEliminar(producto)"
                    title="Eliminar"
                  >
                    <i class="fas fa-trash"></i>
                  </button>

                </div>
              </td>

            </tr>
          </tbody>
        </table>
      </div>

    </div>

  </div>

</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal-overlay" *ngIf="productoAEliminar" (click)="cancelarEliminar()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h4 class="modal-title">
        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
        Confirmar Eliminación
      </h4>
      <button class="btn-close" (click)="cancelarEliminar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>¿Estás seguro de que deseas eliminar el producto?</p>
      <div class="product-to-delete">
        <img 
          [src]="productoAEliminar.imagen || 'assets/images/placeholder-product.jpg'" 
          [alt]="productoAEliminar.nombre"
        >
        <div>
          <strong>{{ productoAEliminar.nombre }}</strong>
          <p>{{ productoAEliminar.categoria }}</p>
        </div>
      </div>
      <p class="text-danger mt-3">
        <i class="fas fa-exclamation-circle me-2"></i>
        Esta acción no se puede deshacer.
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="cancelarEliminar()">
        Cancelar
      </button>
      <button class="btn btn-danger" (click)="eliminarProducto()">
        <i class="fas fa-trash me-2"></i>
        Eliminar Producto
      </button>
    </div>
  </div>
</div>
