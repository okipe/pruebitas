<div class="product-form-page">
  <!-- Header -->
  <div class="page-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="page-title">
            <i
              class="fas me-3"
              [class.fa-edit]="isEditMode"
              [class.fa-plus-circle]="!isEditMode"
            ></i>
            {{ pageTitle }}
          </h1>
          <p class="page-subtitle">
            {{
              isEditMode
                ? "Actualiza la información del producto"
                : "Completa los datos del nuevo producto"
            }}
          </p>
        </div>
        <div class="col-md-4 text-end">
          <button class="btn btn-secondary-custom" routerLink="/admin/products">
            <i class="fas fa-arrow-left me-2"></i>
            Volver
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <!-- Loader -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-3">Cargando producto...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error" class="alert alert-danger" role="alert">
      <i class="fas fa-exclamation-circle me-2"></i>
      {{ error }}
    </div>

    <!-- Formulario -->
    <div *ngIf="!loading" class="form-container">
      <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
        <div class="row">
          <!-- Columna Izquierda -->
          <div class="col-lg-8">
            <div class="form-section">
              <h4 class="section-title">Información Básica</h4>

              <!-- Nombre del Producto -->
              <div class="form-group mb-4">
                <label for="nombre" class="form-label">
                  Nombre del Producto <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  id="nombre"
                  class="form-control"
                  formControlName="nombre"
                  [class.is-invalid]="isFieldInvalid('nombre')"
                  placeholder="Ej: Collar Luna Plateada"
                />
                <div class="invalid-feedback" *ngIf="isFieldInvalid('nombre')">
                  {{ getFieldError("nombre") }}
                </div>
              </div>

              <!-- Descripción -->
              <div class="form-group mb-4">
                <label for="descripcion" class="form-label">
                  Descripción <span class="text-danger">*</span>
                </label>
                <textarea
                  id="descripcion"
                  class="form-control"
                  formControlName="descripcion"
                  [class.is-invalid]="isFieldInvalid('descripcion')"
                  rows="5"
                  placeholder="Describe el producto, sus características y beneficios..."
                ></textarea>
                <div
                  class="invalid-feedback"
                  *ngIf="isFieldInvalid('descripcion')"
                >
                  {{ getFieldError("descripcion") }}
                </div>
                <small class="form-text text-muted">
                  {{ productForm.get("descripcion")?.value?.length || 0 }} / 500
                  caracteres
                </small>
              </div>

              <!-- Categoría -->
              <div class="form-group mb-4">
                <label for="categoria" class="form-label">
                  Categoría <span class="text-danger">*</span>
                </label>
                <select
                  id="categoria"
                  class="form-select"
                  formControlName="categoria"
                  [class.is-invalid]="isFieldInvalid('categoria')"
                >
                  <option [value]="null">Selecciona una categoría</option>
                  <option
                    *ngFor="let cat of categorias"
                    [value]="cat.idCategoria"
                  >
                    {{ cat.nombre }}
                  </option>
                </select>
                <div
                  class="invalid-feedback"
                  *ngIf="isFieldInvalid('categoria')"
                >
                  {{ getFieldError("categoria") }}
                </div>
                <small
                  class="form-text text-muted"
                  *ngIf="categorias.length === 0"
                >
                  ⚠️ No hay categorías disponibles. Crea al menos una categoría
                  primero.
                </small>
              </div>

              <!-- Energía Lunar (Opcional) -->
              <div class="form-group mb-4">
                <label for="energiaLunar" class="form-label">
                  Energía Lunar <small class="text-muted">(Opcional)</small>
                </label>
                <select
                  id="energiaLunar"
                  class="form-select"
                  formControlName="energiaLunar"
                >
                  <option value="">Sin energía lunar específica</option>
                  <option
                    *ngFor="let energia of energiasLunares"
                    [value]="energia"
                  >
                    {{ energia }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <!-- Columna Derecha -->
          <div class="col-lg-4">
            <!-- Precio y Stock -->
            <div class="form-section">
              <h4 class="section-title">Precio e Inventario</h4>

              <!-- Precio -->
              <div class="form-group mb-4">
                <label for="precio" class="form-label">
                  Precio (S/.) <span class="text-danger">*</span>
                </label>
                <input
                  type="number"
                  id="precio"
                  class="form-control"
                  formControlName="precio"
                  [class.is-invalid]="isFieldInvalid('precio')"
                  step="0.01"
                  min="0"
                  placeholder="0.00"
                />
                <div class="invalid-feedback" *ngIf="isFieldInvalid('precio')">
                  {{ getFieldError("precio") }}
                </div>
              </div>

              <!-- Stock -->
              <div class="form-group mb-4">
                <label for="stock" class="form-label">
                  Stock Disponible <span class="text-danger">*</span>
                </label>
                <input
                  type="number"
                  id="stock"
                  class="form-control"
                  formControlName="stock"
                  [class.is-invalid]="isFieldInvalid('stock')"
                  min="0"
                  placeholder="0"
                />
                <div class="invalid-feedback" *ngIf="isFieldInvalid('stock')">
                  {{ getFieldError("stock") }}
                </div>
                <small class="form-text text-muted">
                  Unidades disponibles para la venta
                </small>
              </div>
            </div>

            <!-- Imagen -->
            <div class="form-section">
              <h4 class="section-title">Imagen del Producto</h4>

              <div class="form-group mb-4">
                <label for="imagen" class="form-label">
                  URL de la Imagen <span class="text-danger">*</span>
                </label>
                <input
                  type="url"
                  id="imagen"
                  class="form-control"
                  formControlName="imagen"
                  [class.is-invalid]="isFieldInvalid('imagen')"
                  placeholder="https://ejemplo.com/imagen.jpg"
                />
                <div class="invalid-feedback" *ngIf="isFieldInvalid('imagen')">
                  {{ getFieldError("imagen") }}
                </div>
                <small class="form-text text-muted">
                  Ingresa la URL completa de la imagen
                </small>
              </div>

              <!-- Vista previa de imagen -->
              <div
                class="image-preview"
                *ngIf="productForm.get('imagen')?.value"
              >
                <p class="preview-label">Vista previa:</p>
                <img
                  [src]="productForm.get('imagen')?.value"
                  alt="Vista previa"
                  (error)="
                    $any($event.target).src =
                      'assets/images/placeholder-product.jpg'
                  "
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Botones de Acción -->
        <div class="form-actions">
          <button
            type="button"
            class="btn btn-secondary-custom"
            (click)="onCancel()"
            [disabled]="submitting"
          >
            <i class="fas fa-times me-2"></i>
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary-custom"
            [disabled]="submitting || productForm.invalid"
          >
            <i
              class="fas me-2"
              [class.fa-save]="!submitting"
              [class.fa-spinner]="submitting"
              [class.fa-spin]="submitting"
            ></i>
            {{ submitting ? "Guardando..." : submitButtonText }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
